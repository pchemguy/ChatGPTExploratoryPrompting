# **Debugging Prompts - Insight from Gemini Thinking Log. Multimodal Validation of Chemical Formulas**

In [this work][PWP], I have used this [*test paper*][test paper] to explore applications of advanced prompt engineering techniques to analysis of scholar manuscripts in experimental chemistry. This post continues that work by exploring options for analysis of chemical formulas. The [*test paper*][test paper] constitutes a convenient challenging test case for this task as well (chemical needle in a haystack). Manuscript + SI (a copy of this file is also available from an OSF repository linked from the [preprint][PWP]) combined totals to 44 pages. In this document, page S-8 shows a formula of *ferrous ammonium sulfate* as $\ce{Fe(NH4)2SO4}$ that misses one sulfate. I decided to see how difficult it would be to make a fairly generic prompt to spot this error.

## **Direct Approach**

I started with a basic prompt and tested it using Gemini Advanced 2.5 Pro and ChatGPT Plus o3.
`Find mistakes in chemical formulas and names.`
This basic prompt produced wildly varying results (between runs) with both models. Occasionally, it would actually identify the target problem, but it was essentially useless. After some experiments, I started testing a bit more elaborate prompt:

```
## **Chemical Formula Extraction and Validation from PDF** 

 Execute the following task step-by-step: 
 1. Extract each and every chemical formula from the attached PDF. 
 2. For each extracted formula, extract every directly associated chemical name included in the text, if any. 
 3. For each extracted formula and associated names, consider if the chemical formula and associated names are correct and flag every formula/names combination that contains any errors. 
 4. For each flagged item, read the source PDF again and confirm that the item was extracted exactly. In case of any extraction errors, analyze the corrected item and consider if the flag should be removed. 
 5. Created a Markdown table that should included every flagged formula/names, clear description of any problems, corrected version, and clear reference location of the flagged items.
```

This prompt somewhat improved the overall quality of the output and managed to identify the target problem more frequently, though it was still very unreliable (see sample [Gemini  analysis log][GeminiNaiveAnalysis]).

I tried to vary the prompt, and here is another noteworthy example, illustrated by a [shared AI chat log][GeminiNaiveAnalysisReaction]. This example uses a slightly different prompt that can be seen in the log. The noteworthy, however, is the generated output. The last line in the generated table shows a chemical reaction, not a simple chemical formula, even though the prompt still called for extraction of formulas (`1. Extract each and every chemical formula from the attached PDF.`). The flagged chemical reaction is located in SI on page S-8 right after the problematic $\ce{Fe(NH4)2SO4}$ formula. The LLM flagged this reaction, because it has 3 iron cations on the left side vs. 2 on the right. Basically, out of two high-school-level redox reaction schematics shown in the SI, the authors managed to balance correctly only one. And the imbalanced schematic goes right after an incorrect formula of a chemical also likely encountered in high school chemistry (possibly in advanced classes). Interestingly, because I never tried to specifically look for errors in SI, I have overlooked this imbalanced reaction until the LLM correctly flagged it and provided a proper correction, shown in the third column of the output table generated by LLM.

One advantage of the Gemini chat bot over ChatGPT is that the former actually exposes its thinking process via the "Show thinking" collapsible block. The amount of details shown in this block varies even with similar prompts. Whether this variability reflects actual variability in the thinking process or if this variability is due to selective and variable exposure of the model's thinking process is unclear. Because in chemistry communications, the general practice is that most formulas (except, perhaps, for the most basic ones)  should have accompanying chemical name, I decided to ask the model to extract chemical names for each extracted formula and attempt to identify problem by comparing the formulas and with associated names. While the shared Gemini prompts do not expose the model's thinking logs, it should be fairly straightforward to reproduce the basic [demo analysis][GeminiNaiveAnalysis]. When I examined these logs for different runs, I have noticed that the models was capable of identifying the target formula most of the time and extracted it correctly (as it appears in text). It also extracted the associated name. (A sample log line would look like $\text{"}\ce{Fe(NH4​)2​SO4​}$.**: Ferrous ammonium sulfate (Mohr's salt)"**) The next step was to determine that the formula in text did not match the name. Sometimes Gemini correctly identified this mismatch and suggested proper correction, but sometimes I could see a line in the log similar to this one

$\text{Identified Chemical Formulas/Names and Initial Validation:}$  
$\dots$
$\ce{Fe(NH4​)2​SO4​}: \text{Ferrous ammonium sulfate. Correct.}$

What happens here most likely is the strength of an LLM is manifested makes it harder to flag an error. This issue may be better illustrated by the following prompt: `What is the capital of grate britain? Produce name of the capital only.` It does not matter that I misspelled `Great Britain` and both models spit out "London" - my errors got corrected automatically without LLM bothering me. This is the default behavior and is usually desirable. But not when trying to flag an incorrect chemical formula. A similar and related issue, *input bias*, is discussed in the referenced [preprint][PWP]. *Input bias* is likely associated with specifics of "normal" operation mode of LLMs, and I had to condition the model's context to suppress that issue. And it seems that the present difficulty is similarly related to a "normal" operation mode of LLMs, albeit likely caused by a different aspect of such a mode.

In present case, the process of discovery of a minor deviation of one entity ($\ce{Fe(NH4​)2​SO4​ vs. Fe(NH4​)2​(SO4​)2}$) in a group of associated entities (in present case, the other entity also extracted from text is the name of the compound "$\text{ferrous ammonium sulphate}$"; note, this time the source spelling is used) via "direct contrasting" (`Point 3` in the prompt above) is complicated by LLM's natural ability for error correction, which needs to be either suppressed in a controlled fashion or error detection strategy/algorithm needs to be more complex, avoiding the direct contrasting of "complementary" entities. 

One of my early attempts to avoid the direct contrasting of "complementary" entities (the second strategy) was based on a modified prompt, shown in **"Appendix. Chemical Formula Analysis - Generated Formulas and Names"**, along with the LLM's response. I wanted LLM to generate a chemical name from extracted formula. I anticipated that for minor issues, LLM would generate correct names even from defective formulas. The second step was to have LLM generate a formula from the generated name. Finally, LLM would compare the extracted and generated formulas. This approach was still fairly basic and, while it may have improved the reliability somewhat (or maybe it did not, I have not attempted to perform a rigorous systematic comparison), it remained unreliable. Noteworthy, one of the runs produced a table shown in the same appendix, that included references to various sources (I have checked a few references and found working hyperlinks and reasonable sources).

## **Context Conditioning via PWP Template. Multimodal Formula Analysis**

After numerous unsuccessful attempts (I was able to flag the target formula, but very unreliably), I decided to try a radically different approach by resorting to model's context conditioning discussed in the PWP [preprint][PWP], which also introduced a complex *PeerReviewPrompt* that successfully implemented context conditioning (though it ultimately *input bias* phenomenon, likely having a different, but still related nature).

I pulled sections **I-III**, responsible for general context conditioning, the final section **V**, and section **IV.A** from the *PeerReviewPrompt*. I have retained most of the original contents, except for clauses specifically related to processing workflows described in the main section **IV**. I have introduced **Chemical Identifier Analysis** subsection into the main section **IV** to perform the target task. Because of the way PWP-based *PeerReviewPrompt* is designed, the new [ChemicalFormulasValidationPrompt][ChemicalFormulasValidationPrompt] (partially optimized using meta-prompting techniques discussed in the PWP [preprint][PWP], but not polished linguistically) may be submitted with target PDF attached (may or may not work as expected) or alone.

The second approach should be more robust. In such a case, the second (follow-up) prompt would and have the target PDF attached and initiate analysis: 

`Perform comprehensive Chemical Identifier Analysis`

Demonstration AI chats are provided for [Gemini 2.5 Pro][GeminiAnalysis] and [ChatGPT Plus o3][ChatGPTAnalysis]. Note that the Gemini 2.5 Pro model accessible via [Google AI Studio](https://aistudio.google.com) often performs better than Gemini Advanced 2.5 Pro model accessible via [Gemini app](https://gemini.google.com), and this is the reason why the Gemini demo chat shared here is based on Google AI Studio, and not Gemini app.

While I was discovered a single incorrect formula in SI text and attempted to target reliably, this extended prompt 

## **Appendix. Chemical Formula Analysis - Generated Formulas and Names**

### **Prompt**

```
Execute the following task step-by-step:
1. Extract chemical formulas of each and every chemical species containing at least two elements EXACTLY as they appear in the attached PDF.
2. For each extracted chemical formula generate associated name.
3. Convert each generated name to generated chemical formula.
4. For each generated chemical formula, determine if it matches previously extracted formula.
```
### **Response**

#### Chemical Species Analysis from PDF

Here's an analysis of the chemical species found in the provided PDF document, "Enrichment of H2 17O from Tap Water, Characterization of the Enriched Water, and Properties of Several 17O-Labeled Compounds."

##### Extracted Chemical Formulas, Generated Names, and Formula Comparison

The following table details the chemical formulas extracted directly from the PDF (containing at least two elements), their generated chemical names, the chemical formulas regenerated from these names, and a comparison to determine if the original and regenerated formulas match.

|       |                                  |                                  |                                                |                                                                                                                                        |                                                                                                                                                                                                                                        |
| ----- | -------------------------------- | -------------------------------- | ---------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **#** | **Extracted Formula (from PDF)** | **Generated Chemical Name**      | **Regenerated Chemical Formula (from Name)**   | **Matches Original?**                                                                                                                  | **Source(s) for Name/Regenerated Formula**                                                                                                                                                                                             |
| 1     | H217​O                           | Water-17O                        | H2​17O                                         | Yes                                                                                                                                    | [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/602949), [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/603058)                                                                                 |
| 2     | CDCl3​                           | Deuterated chloroform            | CDCl3​                                         | Yes                                                                                                                                    | [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:85365), [Wikipedia](https://en.wikipedia.org/wiki/Deuterated_chloroform)                                                                                              |
| 3     | Na17OH                           | Sodium hydroxide-17O             | Na17OH (or HNa17O)                             | Yes                                                                                                                                    | Name manually determined due to ambiguous search; Formula from [ChemSpider](https://www.chemspider.com/Chemical-Structure.9346004.html)                                                                                                |
| 4     | H217​O2​                         | Hydrogen peroxide-17O2           | H2​17O2​                                       | Yes                                                                                                                                    | [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/574864), [ChemSpider](https://www.chemspider.com/Chemical-Structure.58824490.html)                                                                                  |
| 5     | H2​O2​                           | Hydrogen peroxide                | H2​O2​                                         | Yes                                                                                                                                    | [Britannica](https://www.britannica.com/science/hydrogen-peroxide), [US EPA](https://cdxapps.epa.gov/oms-substance-registry-services/substance-details/153015), [AccessScience](https://www.accessscience.com/content/article/a329200) |
| 6     | NO                               | Nitric oxide (Nitrogen monoxide) | NO                                             | Yes                                                                                                                                    | [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:16480)                                                                                                                                                                |
| 7     | H2​O                             | Water (Oxidane)                  | H2​O                                           | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Water), [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Water)                                                                                                                           |
| 8     | H218​O                           | Water-18O                        | H2​18O                                         | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Water-18O), [NIST WebBook](https://webbook.nist.gov/cgi/cbook.cgi?ID=C14314422&Mask=4)                                                                                             |
| 9     | KH2​PO4​                         | Potassium dihydrogen phosphate   | KH2​PO4​                                       | Yes                                                                                                                                    | [American Chemical Society](https://www.acs.org/molecule-of-the-week/archive/p/potassium-dihydrogen-phosphate.html), [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:63036)                                           |
| 10    | K2​HPO4​                         | Dipotassium phosphate            | K2​HPO4​                                       | Yes                                                                                                                                    | [DrugBank](https://go.drugbank.com/drugs/DB09414), [Wikipedia](https://en.wikipedia.org/wiki/Dipotassium_phosphate), [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Dipotassium-phosphate)                                        |
| 11    | KCl                              | Potassium chloride               | KCl                                            | Yes                                                                                                                                    | [BYJU'S](https://byjus.com/chemistry/potassium-chloride/), [Wikipedia](https://en.wikipedia.org/wiki/Potassium_chloride)                                                                                                               |
| 12    | RuO2​                            | Ruthenium(IV) oxide              | RuO2​                                          | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Ruthenium\(IV\)_oxide)                                                                                                                                                                       |
| 13    | NaI                              | Sodium iodide                    | NaI                                            | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Sodium_iodide)                                                                                                                                                                               |
| 14    | H216​O                           | Water-16O                        | H2​16O                                         | Yes                                                                                                                                    | [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/329886), [SSHADE](https://www.sshade.eu/data/specie/MOLEC_1H216O)                                                                                                   |
| 15    | CH4​                             | Methane                          | CH4​                                           | Yes                                                                                                                                    | [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:16183), [Wikipedia](https://en.wikipedia.org/wiki/Methane)                                                                                                            |
| 16    | HCl                              | Hydrogen chloride                | HCl                                            | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Hydrogen_chloride), [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:17883)                                                                                                  |
| 17    | NaOH                             | Sodium hydroxide                 | NaOH                                           | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Sodium_hydroxide), [The Chlorine Institute](https://www.chlorineinstitute.org/sodium-hydroxide)                                                                                              |
| 18    | NaCl                             | Sodium chloride                  | NaCl                                           | Yes                                                                                                                                    | [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:26710), [Taylor & Francis](https://taylorandfrancis.com/knowledge/Engineering_and_technology/Chemical_engineering/Sodium_chloride/)                                   |
| 19    | Na2​CO3​                         | Sodium carbonate                 | Na2​CO3​                                       | Yes                                                                                                                                    | [Home Science Tools](https://www.homesciencetools.com/product/sodium-carbonate-30-g/), [Wikipedia](https://en.wikipedia.org/wiki/Sodium_carbonate)                                                                                     |
| 20    | NaHCO3​                          | Sodium bicarbonate               | NaHCO3​                                        | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Sodium_bicarbonate), [EBSCO Research Starters](https://www.ebsco.com/research-starters/chemistry/sodium-bicarbonate)                                                                         |
| 21    | Na2​SO4​                         | Sodium sulfate                   | Na2​SO4​                                       | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Sodium-Sulfate), [Wikipedia](https://en.wikipedia.org/wiki/Sodium_sulfate)                                                                                                         |
| 22    | MgSO4​                           | Magnesium sulfate                | MgSO4​                                         | Yes                                                                                                                                    | [FAO](https://www.fao.org/fileadmin/templates/agns/pdf/jecfa/cta/68/Magnesium_Sulfate.pdf)                                                                                                                                             |
| 23    | CF3​                             | Trifluoromethyl radical          | CF3​                                           | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Trifluoromethyl-radical)                                                                                                                                                           |
| 24    | NH2​                             | Amino radical                    | NH2​ (or NH2​⋅)                                | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Amino_radical), [Wikipedia](https://en.wikipedia.org/wiki/NH2)                                                                                                                               |
| 25    | CD3​CN                           | Acetonitrile-d3                  | CD3​CN                                         | Yes                                                                                                                                    | [Merck Millipore](https://www.merckmillipore.com/INTL/en/product/Acetonitrile-D3,MDA_CHEM-102904), [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/151807)                                                          |
| 26    | CCl4​                            | Carbon tetrachloride             | CCl4​                                          | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Carbon-Tetrachloride)                                                                                                                                                              |
| 27    | KMnO4​                           | Potassium permanganate           | KMnO4​                                         | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Potassium-Permanganate), [DermNet](https://dermnetnz.org/topics/potassium-permanganate)                                                                                            |
| 28    | Fe(NH4​)2​SO4​                   | Ferrous ammonium sulfate         | (NH4​)2​Fe(SO4​)2​ or Fe(NH4​)2​(SO4​)2​⋅6H2​O | No (Original likely a typo or refers to a different species than common Ferrous Ammonium Sulfate / Mohr's Salt which is a double salt) | [EMBL-EBI](https://www.ebi.ac.uk/chebi/searchId.do?printerFriendlyView=true&chebiId=76243&structureView=applet), [CAMEO Chemicals - NOAA](https://cameochemicals.noaa.gov/chemical/3473)                                               |
| 29    | KSCN                             | Potassium thiocyanate            | KSCN                                           | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Potassium_thiocyanate), [Spectrum Chemical](https://www.spectrumchemical.com/cas/333-20-0)                                                                                                   |
| 30    | Fe(SCN)3​                        | Iron(III) thiocyanate            | Fe(SCN)3​ (or C3​FeN3​S3​)                     | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Ferric-thiocyanate), [American Chemical Society](https://www.acs.org/content/acs/en/molecule-of-the-week/archive/i/iron-thiocyanate.html)                                          |
| 31    | CH3​(CH2​)5​OH                   | 1-Hexanol (Hexan-1-ol)           | C6​H14​O (or CH3​(CH2​)5​OH)                   | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/1-Hexanol), [Wikipedia](https://en.wikipedia.org/wiki/1-Hexanol)                                                                                                                   |
| 32    | (CH3​)3​SiOH                     | Trimethylsilanol                 | (CH3​)3​SiOH (or C3​H10​OSi)                   | Yes                                                                                                                                    | [Sigma-Aldrich](https://www.sigmaaldrich.com/US/en/product/aldrich/725986), [Wikipedia](https://en.wikipedia.org/wiki/Trimethylsilanol)                                                                                                |
| 33    | ((CH3​)3​Si)2​O                  | Hexamethyldisiloxane             | ((CH3​)3​Si)2​O (or C6​H18​OSi2​)              | Yes                                                                                                                                    | [Wikipedia](https://en.wikipedia.org/wiki/Hexamethyldisiloxane), [Thermo Fisher](https://www.thermofisher.com/order/catalog/product/A11848.0F), [Ereztech](https://ereztech.com/product/hexamethyldisiloxane-107-46-0/)                |
| 34    | CF3​CONH2​                       | Trifluoroacetamide               | CF3​CONH2​ (or C2​H2​F3​NO)                    | Yes                                                                                                                                    | [PubChem](https://pubchem.ncbi.nlm.nih.gov/compound/Trifluoroacetamide), [Fisher Scientific](https://www.fishersci.ca/shop/products/2-2-2-trifluoroacetamide-97-thermo-scientific-1/p-7021918)                                         |

**Note on Fe(NH4​)2​SO4​:** The extracted formula Fe(NH4​)2​SO4​ does not directly correspond to the common compound Ferrous Ammonium Sulfate (Mohr's Salt), which is a double salt with the formula (NH4​)2​Fe(SO4​)2​ or its hexahydrate Fe(NH4​)2​(SO4​)2​⋅6H2​O. The extracted formula suggests a 1:1 ratio of ammonium to sulfate, whereas Mohr's salt has a 2:2 (or 1:1 after simplifying the sulfate part if written as FeSO4​⋅(NH4​)2​SO4​⋅6H2​O). The regenerated formula from the name "Ferrous ammonium sulfate" typically refers to the double salt. The PDF on page S-8 in the supporting information lists "Fe(NH4​)2​SO4​" when discussing the quantitation of H2​O2​. This might be a specific notation or a typo in the source document for what is commonly known as Mohr's Salt, or a different, less common species.

The analysis involved extracting formulas exactly as they appeared in the PDF, using web searches to generate their common chemical names, and then using those names to regenerate chemical formulas for comparison.


## **References**

<!-- References-->

[PWP]: https://arxiv.org/abs/2505.03332
[test paper]: https://doi.org/10.1021/ac1022887
[ChemicalFormulasValidationPrompt]: https://github.com/pchemguy/ChatGPTExploratoryPrompting/blob/main/PWP/ChemicalFormulasValidationPrompt.md
[GeminiNaiveAnalysis]: https://g.co/gemini/share/a62c19799936
[GeminiNaiveAnalysisReaction]: https://g.co/gemini/share/70cd2d7b296b
[GeminiAnalysis]: https://aistudio.google.com/app/prompts/1CUpdXeLstQQp1y0UZ9R9ZvaBuhy6CNW1
[ChatGPTAnalysis]: https://chatgpt.com/share/681f5b9f-375c-8004-b2f4-294c75371945
